<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Register User - Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .credentials-preview {
            background-color: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .student-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .teacher-section {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
        }
        .admin-section {
            background: #f8d7da;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #dc3545;
        }
        .password-section {
            background: #d1ecf1;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .generate-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Student Admin System</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin/dashboard">Dashboard</a>
                <a class="nav-link active" href="/admin/register-user">Register User</a>
                <a class="nav-link" href="/students">Students</a>
                <a class="nav-link" href="/logout">Logout</a>
            </div>
        </div>
    </nav>

    <h2>Register New User</h2>
    <p class="text-muted">Administrator: Register new students, teachers, or administrators</p>

    <!-- Success Message -->
    <div th:if="${success}" class="alert alert-success" th:utext="${success}"></div>

    <!-- Error Message -->
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <form th:action="@{/admin/register-user}" method="post">
        <!-- Role Selection -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">User Role</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="role" class="form-label">Select Role *</label>
                    <select class="form-control" id="role" name="role" required onchange="toggleRoleFields()">
                        <option value="">Choose Role...</option>
                        <option value="STUDENT">Student</option>
                        <option value="TEACHER">Teacher</option>
                        <option value="ADMIN">Administrator</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Student Section -->
        <div id="studentSection" class="student-section" style="display: none;">
            <h4>üéì Student Information</h4>

            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="studentId" class="form-label">Student ID *</label>
                        <input type="text" class="form-control" id="studentId" name="studentId"
                               placeholder="e.g., S11200000" oninput="updateStudentCredentials()">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="firstName" class="form-label">First Name *</label>
                        <input type="text" class="form-control" id="firstName" name="firstName"
                               placeholder="First Name" oninput="updateStudentCredentials()">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="lastName" class="form-label">Last Name *</label>
                        <input type="text" class="form-control" id="lastName" name="lastName"
                               placeholder="Last Name">
                    </div>
                </div>
            </div>

            <!-- Student Auto-generated Credentials -->
            <div id="studentCredentials" class="credentials-preview" style="display: none;">
                <h6>Auto-generated Student Credentials:</h6>
                <div>
                    <strong>Username:</strong> <span id="studentUsernamePreview" class="text-primary">[Enter Student ID]</span><br>
                    <strong>Email:</strong> <span id="studentEmailPreview" class="text-primary">[Enter Student ID]</span>
                </div>
            </div>
        </div>

        <!-- Teacher Section -->
        <div id="teacherSection" class="teacher-section" style="display: none;">
            <h4>Teacher Information</h4>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="teacherId" class="form-label">Teacher ID</label>
                        <input type="text" class="form-control" id="teacherId" name="teacherId"
                               placeholder="e.g., T001 (Optional)" oninput="updateTeacherCredentials()">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="teacherFullName" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="teacherFullName" name="teacherFullName"
                               placeholder="Full Name (Optional)">
                    </div>
                </div>
            </div>

            <!-- Teacher Auto-generated Credentials -->
            <div id="teacherCredentials" class="credentials-preview" style="display: none;">
                <h6>Auto-generated Teacher Credentials:</h6>
                <div>
                    <strong>Username:</strong> <span id="teacherUsernamePreview" class="text-primary">[Enter Teacher ID]</span><br>
                    <strong>Email:</strong> <span id="teacherEmailPreview" class="text-primary">[Enter Teacher ID]</span>
                </div>
            </div>
        </div>

        <!-- Manual Credentials Section (for all roles) -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Account Credentials</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username *</label>
                            <input type="text" class="form-control" id="username" name="username"
                                   placeholder="Username for login" required>
                            <div class="form-text" id="usernameHelp">
                                For students: Auto-generated from Student ID
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="email" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="email" name="email"
                                   placeholder="user@domain.com" required>
                            <div class="form-text" id="emailHelp">
                                For students: Auto-generated as studentID@student.com
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Password Section -->
        <div class="password-section">
            <h4>üîê Set Password</h4>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="password" class="form-label">Password </label>
                        <input type="password" class="form-control" id="password" name="password"
                               placeholder="Enter password" required minlength="6">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm Password </label>
                        <input type="password" class="form-control" id="confirmPassword"
                               placeholder="Confirm password" required minlength="6">
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <button type="button" class="generate-btn" onclick="generateRandomPassword()">
                    Generate Secure Password
                </button>
                <small class="text-muted">Click to generate a strong random password</small>
            </div>
            <div id="passwordStrength" class="form-text"></div>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-success btn-lg">Register User</button>
            <a href="/admin/dashboard" class="btn btn-secondary btn-lg">Cancel</a>
        </div>
    </form>
</div>

<script>
    function toggleRoleFields() {
        const role = document.getElementById('role').value;

        // Hide all sections
        document.getElementById('studentSection').style.display = 'none';
        document.getElementById('teacherSection').style.display = 'none';

        // Reset help text
        document.getElementById('usernameHelp').textContent = 'Enter username for login';
        document.getElementById('emailHelp').textContent = 'Enter email address';

        // Show relevant section and update help text
        if (role === 'STUDENT') {
            document.getElementById('studentSection').style.display = 'block';
            document.getElementById('usernameHelp').textContent = 'Auto-generated from Student ID';
            document.getElementById('emailHelp').textContent = 'Auto-generated as studentID@student.com';
            updateStudentCredentials();
        } else if (role === 'TEACHER') {
            document.getElementById('teacherSection').style.display = 'block';
            document.getElementById('usernameHelp').textContent = 'Enter manually or use Teacher ID above';
            document.getElementById('emailHelp').textContent = 'Enter manually or use Teacher ID above';
            updateTeacherCredentials();
        } else if (role === 'ADMIN') {
            document.getElementById('usernameHelp').textContent = 'Enter administrator username';
            document.getElementById('emailHelp').textContent = 'Enter administrator email';
        }
    }

    function updateStudentCredentials() {
        const studentId = document.getElementById('studentId').value;
        const studentCredentials = document.getElementById('studentCredentials');

        if (studentId) {
            // Auto-fill username and email for students
            document.getElementById('username').value = studentId;
            document.getElementById('email').value = studentId.toLowerCase() + '@student.com';

            // Update preview
            document.getElementById('studentUsernamePreview').textContent = studentId;
            document.getElementById('studentEmailPreview').textContent = studentId.toLowerCase() + '@student.com';
            studentCredentials.style.display = 'block';
        } else {
            studentCredentials.style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('email').value = '';
        }
    }

    function updateTeacherCredentials() {
        const teacherId = document.getElementById('teacherId').value;
        const teacherCredentials = document.getElementById('teacherCredentials');

        if (teacherId) {
            // Auto-fill username and email for teachers
            document.getElementById('username').value = teacherId;
            document.getElementById('email').value = teacherId.toLowerCase() + '@teacher.com';

            // Update preview
            document.getElementById('teacherUsernamePreview').textContent = teacherId;
            document.getElementById('teacherEmailPreview').textContent = teacherId.toLowerCase() + '@teacher.com';
            teacherCredentials.style.display = 'block';
        } else {
            teacherCredentials.style.display = 'none';
            // Don't clear manual fields - let admin enter manually
        }
    }

    function generateRandomPassword() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%';
        let password = '';
        for (let i = 0; i < 12; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }

        document.getElementById('password').value = password;
        document.getElementById('confirmPassword').value = password;
        checkPasswordStrength(password);
    }

    function checkPasswordStrength(password) {
        const strengthDiv = document.getElementById('passwordStrength');
        let strength = 0;

        if (password.length >= 8) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[!@#$%]/.test(password)) strength++;

        let feedback = '';
        switch(strength) {
            case 0: case 1:
                feedback = '<span style="color: red;">Weak password</span>';
                break;
            case 2: case 3:
                feedback = '<span style="color: orange;">Medium password</span>';
                break;
            case 4:
                feedback = '<span style="color: green;">Strong password</span>';
                break;
            case 5:
                feedback = '<span style="color: darkgreen;">Very strong password</span>';
                break;
        }
        strengthDiv.innerHTML = feedback;
    }

    // Form validation
    document.querySelector('form').addEventListener('submit', function(e) {
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const role = document.getElementById('role').value;

        if (password !== confirmPassword) {
            alert('Passwords do not match!');
            e.preventDefault();
            return false;
        }

        if (role === 'STUDENT') {
            const studentId = document.getElementById('studentId').value;
            const firstName = document.getElementById('firstName').value;
            if (!studentId || !firstName) {
                alert('Please fill in all required student fields (Student ID and First Name)');
                e.preventDefault();
                return false;
            }
        }
    });

    // Password strength checker
    document.getElementById('password').addEventListener('input', function() {
        checkPasswordStrength(this.value);
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        toggleRoleFields();
    });
</script>
</body>
</html>